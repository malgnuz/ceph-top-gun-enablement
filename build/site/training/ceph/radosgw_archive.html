<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RadosGW Archive Zone :: Ceph Top Gun Enablement</title>
    <link rel="canonical" href="https://likid0.github.io/ceph-top-gun-enablement/training/ceph/radosgw_archive.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="48px" alt="Ceph">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/zh-cn/red_hat_ceph_storage/5" target="_blank">Ceph Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/likid0/ceph-top-gun-enablement/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">Ceph Storage Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Ceph Top-Gun Enablement</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Lab Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opentlc_lab_env.html">Opentlc Lab Env</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Ceph</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_introduction.html">Ceph Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_architecture.html">Ceph Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cluster_partitioning.html">Ceph Cluster Partitioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_hardware.html">Ceph Hardware Recommendations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_intro.html">Ceph Install Methods </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephadm_intro.html">Cephadm Orchestrator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_basic.html">Deploy Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_ui.html">Deploy Ceph from the UI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_dashboard_metrics.html">Ceph Dashboard Management &amp; Metrics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cli_intro.html">Ceph CLI basic commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_configuration.html">Ceph Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_pools.html">Ceph storage pools config</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_pgs.html">Ceph Health and PGs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_bluestore.html">Ceph OSD Bluestore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_recovery.html">Ceph OSD Failure/Recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephx.html">Rados CephX Auth/AuthZ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_version.html">What version of Ceph am I running?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph-upgrades_cephadm.html">Upgrade Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_challenge.html">Challenge Ceph Deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RADOS Block Device</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_intro.html">RADOS Block Device introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_export.html">RBD Import/Export</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_mirroring.html">RBD Mirroring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_challenge.html">Challenge RBD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CephFS Shared FileSystem</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_intro.html">CephFS introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_advanced.html">CephFS Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephfs_challenge.html">Challenge Cephfs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RadosGW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_intro.html">RGW Introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_arch_deep_dive.html">RGW Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ha.html">RGW High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ssl.html">RGW &amp; Ingress with SSL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_users_quotas.html">RGW Users &amp; Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_auth.html">RGW Auth &amp; Authz</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_object_versioning.html">RGW S3 Object Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_placement_and_storage_classes.html">RGW Placement &amp; Storage Classes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_life_cycle_management.html">RGW Life Cycle Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_policy.html">RGW S3 Bucket Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_introduction.html">RGW Secure Token Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_bucket_role_policy.html">RGW Bucket vs Role Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_cloudsync.html">RGW Object Cloud Transition</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="radosgw_archive.html">RGW Archive Zone</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_presignedurl.html">RGW presigned URL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_opslog.html">RGW Opslog</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_notification.html">RGW bucket Notification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_rgw_challenge.html">Challenge RGW</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_logging.html">Troubleshooting Logs Debug Mode</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-nearfull-osds.html">Troubleshooting nearfull OSDs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_bluestore.html">Troubleshooting Bluestore issues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-large-omap-objects.html">Troubleshooting Large Omap Objects</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_break_and_fix.html">Troubleshooting Break &amp; Fix Hands-on</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Benchmarking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_example.html">Setting the Inital Baseline</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_fio.html">Benchmarking Ceph block and File</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_object.html">Benchmarking Ceph Object(RGW)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Stretched</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rhcs-stretched-deploy.html">Ceph Stretch Mode</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Challenge Solutions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_challenge_solution.html">Ceph Deployment Solution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_challenge_solution.html">Ceph RBD Solution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephfs_challenge_solution.html">Ceph CephFS Solution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_rgw_challenge_solution.html">Ceph RGW Solution</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ceph Top-Gun Enablement</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Ceph Top-Gun Enablement</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Ceph Top-Gun Enablement</a></li>
    <li>Ceph RadosGW</li>
    <li><a href="radosgw_archive.html">RGW Archive Zone</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/training/modules/ceph/pages/radosgw_archive.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">RadosGW Archive Zone</h1>
<div class="sect1">
<h2 id="_introductiontp_in_5_3"><a class="anchor" href="#_introductiontp_in_5_3"></a>1. Introduction(TP in 5.3)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This sync module leverages the versioning feature of the S3 objects in RGW to have an archive zone that captures the different versions of the S3 objects as they occur over time in the other zones.</p>
</div>
<div class="paragraph">
<p>An archive zone allows to have a history of versions of S3 objects that can only be eliminated through the gateways associated with the archive zone.</p>
</div>
<div class="paragraph">
<p>This functionality is useful to have a configuration where several non-versioned zones replicate their data and metadata through their zone gateways (mirror configuration) providing high availability to the end users, while the archive zone captures all the data updates and metadata for consolidate them as versions of S3 objects.</p>
</div>
<div class="paragraph">
<p>Including an archive zone in a multizone configuration allows you to have the flexibility of an S3 object history in one only zone while saving the space that the replicas of the versioned S3 objects would consume in the rest of the zones.</p>
</div>
<div class="paragraph">
<p>RGW archive zone and has the following main characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Versioning is enabled in all buckets in the RGW archive zone.</p>
</li>
<li>
<p>Every time a user uploads a new object, this object is asynchronous replicated to the archive zone.</p>
</li>
<li>
<p>If an object is modified, a new version is generated in the archive zone.</p>
</li>
<li>
<p>If an object is deleted, the object is kept in the archive zone.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_archive_zone_lab"><a class="anchor" href="#_archive_zone_lab"></a>2. Archive Zone Lab.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we are going to deploy an advanced configuration that consists of a
single realm with one zone group and two zones, one zone will be the production
zone, and the second zone will be the archive zone, each zone with two Ceph RGW
instances. Each zone is backed by its own Ceph Storage Cluster.</p>
</div>
<div class="sect2">
<h3 id="_configure_the_master_realm_zonegroup_and_zone"><a class="anchor" href="#_configure_the_master_realm_zonegroup_and_zone"></a>2.1. Configure the Master Realm, Zonegroup and Zone.</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have already completed the RadosGW introduction module, you will have
the realm,zonegroup and zone(zone1) created, but with no endpoints configured,
you will need to add valid rgw endpoints to the zonegroup and zone.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zone modify --endpoints=http://proxy01:8000 --rgw-zone=zone1
# radosgw-admin zonegroup modify --endpoints=http://proxy01:8000  --rgw-zonegroup=multizg
# radosgw-admin zone modify --access-key=sync --secret=sync --rgw-zone=zone1
# radosgw-admin period update --rgw-realm=multisite --commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then skip to section 2.3</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have done the virtual host configuration from the RadosGW introduction
module it needs to be removed, before you continue with this lab</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Always Run commands on the master/primary cluster.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a realm:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># radosgw-admin realm create --rgw-realm=multisite --default
{
    "id": "ce31cd75-37c4-4b10-91db-1cda1ca12d95",
    "name": "multisite",
    "current_period": "0ad144e7-a880-43ab-8a64-c9deaf581280",
    "epoch": 1
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a zone group:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># radosgw-admin zonegroup create --rgw-zonegroup=multizg --endpoints=http://proxy01:8000 --master --default
{
    "id": "2e41dde9-80f4-4ec8-a099-ec0e8a60938d",
    "name": "multizg",
    "api_name": "multizg",
    "is_master": "true",
    "endpoints": [],
    "hostnames": [],
    "hostnames_s3website": [],
    "master_zone": "",
    "zones": [],
    "placement_targets": [],
    "default_placement": "",
    "realm_id": "ce31cd75-37c4-4b10-91db-1cda1ca12d95",
    "sync_policy": {
        "groups": []
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have more than one RGW service running per zone, as you would do for
production, you can add all the rgw address to the endpoints list
--endpoints=http://proxy01:8000,http://ceph-node02:8000 for example, if we want
the sync to survive DNS outages we can use the IP for the endpoints instead
of the Hostnames.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a zone:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># radosgw-admin zone create --rgw-zonegroup=multizg --rgw-zone=zone1 --access-key=sync --secret=sync --master --default --endpoints=http://proxy01:8000
{
    "id": "0e06b95f-3b6e-4a1c-95e8-b857f699e9e3",
    "name": "zone1",
    "domain_root": "zone1.rgw.meta:root",
    "control_pool": "zone1.rgw.control",
    "gc_pool": "zone1.rgw.log:gc",
    "lc_pool": "zone1.rgw.log:lc",
    "log_pool": "zone1.rgw.log",
    "intent_log_pool": "zone1.rgw.log:intent",
    "usage_log_pool": "zone1.rgw.log:usage",
    "roles_pool": "zone1.rgw.meta:roles",
    "reshard_pool": "zone1.rgw.log:reshard",
    "user_keys_pool": "zone1.rgw.meta:users.keys",
    "user_email_pool": "zone1.rgw.meta:users.email",
    "user_swift_pool": "zone1.rgw.meta:users.swift",
    "user_uid_pool": "zone1.rgw.meta:users.uid",
    "otp_pool": "zone1.rgw.otp",
    "system_key": {
        "access_key": "sync",
        "secret_key": "sync"
    },
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "zone1.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "zone1.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "zone1.rgw.buckets.non-ec",
                "index_type": 0
            }
        }
    ],
    "realm_id": "b3f73708-67c5-4b19-b378-6af9cc66c0b0",
    "notif_pool": "zone1.rgw.log:notif"
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We can have one or mode REALMS,ZONEGROUPS or ZONES, if we don&#8217;t specify
them on the radosgw-admin command with --rgw-realm , --rgw-zonegroup= ,
--rgw-zone= , the radosgw-admin command will use the ones set as the default
using the --default flag like we did in the previous commands.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Commit the changes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">[ceph: root@ceph-mon01 /]# radosgw-admin period update --rgw-realm=multisite --commit</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the RGW daemons with the name <code>multi.zone1</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">[ceph: root@ceph-mon01 /]# ceph orch apply rgw multi.zone1 --realm=multisite --zone=zone1 --placement="2 proxy01 ceph-node02" --port=8000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">Scheduled multi.zone1 update...
# ceph orch ps | grep rgw
rgw.multi.zone1.ceph-node02.lviwfb  ceph-node02  *:8000       running (3m)      3m ago   3m    45.7M        -  16.2.8-85.el8cp  b2c997ff1898  0e3521f3a162
rgw.multi.zone1.proxy01.mhawfj      proxy01      *:8000       running (30m)     4m ago  30m    61.9M        -  16.2.8-85.el8cp  b2c997ff1898  4de70934f04e</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_sync_user"><a class="anchor" href="#_create_sync_user"></a>2.2. Create Sync User</h3>
<div class="paragraph">
<p>Create a system user that we will use to configure the sync between sites.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin user create --uid=syncuser --display-name="syncuser" --access-key=sync --secret=sync --system</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_archive_zone"><a class="anchor" href="#_configure_archive_zone"></a>2.3. Configure Archive Zone</h3>
<div class="paragraph">
<p>Steps to configure the RADOS Gateway instance on the Archive zone.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Run commands on the secondary/Archive Ceph cluster, in our example ceph-mon01</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin realm pull --rgw-realm=multisite  --url=http://proxy01:8000 --access-key=sync --secret=sync --default
2022-12-23T09:26:56.377-0500 7fccf8715500  1 error read_lastest_epoch .rgw.root:periods.e7ccb8e8-4a93-4a87-9a6d-8a650696e839.latest_epoch
2022-12-23T09:26:56.415-0500 7fccf8715500  1 Set the period's master zonegroup 6b9fbc87-3202-4a35-85d0-e3e16fc91b32 as the default
{
    "id": "e72107cb-4b3f-49b9-abb0-83c68a9967f9",
    "name": "multisite",
    "current_period": "e7ccb8e8-4a93-4a87-9a6d-8a650696e839",
    "epoch": 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pull the period.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin period pull --url=http://proxy01:8000 --access-key=sync --secret=sync
{
    "id": "e7ccb8e8-4a93-4a87-9a6d-8a650696e839",
    "epoch": 5,
    "predecessor_uuid": "68a74587-6404-4798-83e0-6cd3bf417288",
    "sync_status": [],
    "period_map": {
        "id": "e7ccb8e8-4a93-4a87-9a6d-8a650696e839",
        "zonegroups": [
            {
                "id": "6b9fbc87-3202-4a35-85d0-e3e16fc91b32",
                "name": "multizg",
                "api_name": "multizg",
                "is_master": "true",
                "endpoints": [],
                "hostnames": [],
                "hostnames_s3website": [],
                "master_zone": "c5dc9503-6c11-4851-91bd-f1d5ca61473c",
                "zones": [
                    {
                        "id": "c5dc9503-6c11-4851-91bd-f1d5ca61473c",
                        "name": "zone1",
                        "endpoints": [],
                        "log_meta": "false",
                        "log_data": "false",
                        "bucket_index_max_shards": 11,
                        "read_only": "false",
                        "tier_type": "",
                        "sync_from_all": "true",
                        "sync_from": [],
                        "redirect_zone": ""
                    }
                ],
                "placement_targets": [
                    {
                        "name": "default-placement",
                        "tags": [],
                        "storage_classes": [
                            "SSD",
                            "STANDARD"
                        ]
                    },
                    {
                        "name": "ssd",
                        "tags": [
                            "allowed-ssd"
                        ],
                        "storage_classes": [
                            "STANDARD"
                        ]
                    }
                ],
                "default_placement": "default-placement",
                "realm_id": "e72107cb-4b3f-49b9-abb0-83c68a9967f9",
                "sync_policy": {
                    "groups": []
                }
            }
        ],
        "short_zone_ids": [
            {
                "key": "c5dc9503-6c11-4851-91bd-f1d5ca61473c",
                "val": 2695141038
            }
        ]
    },
    "master_zonegroup": "6b9fbc87-3202-4a35-85d0-e3e16fc91b32",
    "master_zone": "c5dc9503-6c11-4851-91bd-f1d5ca61473c",
    "period_config": {
        "bucket_quota": {
            "enabled": false,
            "check_on_raw": false,
            "max_size": -1,
            "max_size_kb": 0,
            "max_objects": -1
        },
        "user_quota": {
            "enabled": false,
            "check_on_raw": false,
            "max_size": -1,
            "max_size_kb": 0,
            "max_objects": -1
        }
    },
    "realm_id": "e72107cb-4b3f-49b9-abb0-83c68a9967f9",
    "realm_name": "multisite",
    "realm_epoch": 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the archive zone.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zone create --rgw-zone=archive --rgw-zonegroup=multizg --endpoints=http://proxy02:8000 --access-key=sync --secret=sync --default --tier-type=archive
2023-03-15T07:23:42.554-0400 7ffb657fd500  0 failed reading obj info from .rgw.root:zone_info.1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f: (2) No such file or directory
2023-03-15T07:23:42.554-0400 7ffb657fd500  0 WARNING: could not read zone params for zone id=1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f name=zone1
{
    "id": "d7c2da60-e269-4681-a231-e744d1f0dc8a",
    "name": "archive",
    "domain_root": "archive.rgw.meta:root",
    "control_pool": "archive.rgw.control",
    "gc_pool": "archive.rgw.log:gc",
    "lc_pool": "archive.rgw.log:lc",
    "log_pool": "archive.rgw.log",
    "intent_log_pool": "archive.rgw.log:intent",
    "usage_log_pool": "archive.rgw.log:usage",
    "roles_pool": "archive.rgw.meta:roles",
    "reshard_pool": "archive.rgw.log:reshard",
    "user_keys_pool": "archive.rgw.meta:users.keys",
    "user_email_pool": "archive.rgw.meta:users.email",
    "user_swift_pool": "archive.rgw.meta:users.swift",
    "user_uid_pool": "archive.rgw.meta:users.uid",
    "otp_pool": "archive.rgw.otp",
    "system_key": {
        "access_key": "sync",
        "secret_key": "sync"
    },
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "archive.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "archive.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "archive.rgw.buckets.non-ec",
                "index_type": 0
            }
        }
    ],
    "realm_id": "da2a45d7-764b-4c92-a28a-049d02c8c22f",
    "notif_pool": "archive.rgw.log:notif"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commit the changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin period update --commit
2023-03-15T07:24:31.295-0400 7f62337c9500  1 Cannot find zone id=d7c2da60-e269-4681-a231-e744d1f0dc8a (name=archive), switching to local zonegroup configuration
Sending period to new master zone 1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f
{
    "id": "9c4eba19-7849-48cf-8024-7fe44067a9a9",
    "epoch": 2,
    "predecessor_uuid": "40025556-2e6b-4a26-af36-89158d79816c",
    "sync_status": [],
    "period_map": {
        "id": "9c4eba19-7849-48cf-8024-7fe44067a9a9",
        "zonegroups": [
            {
                "id": "fc3debfe-2a29-448b-baa8-1e54c7eee9b1",
                "name": "multizg",
                "api_name": "multizg",
                "is_master": "true",
                "endpoints": [
                    "http://proxy01:8000"
                ],
                "hostnames": [],
                "hostnames_s3website": [],
                "master_zone": "1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f",
                "zones": [
                    {
                        "id": "1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f",
                        "name": "zone1",
                        "endpoints": [
                            "http://proxy01:8000"
                        ],
                        "log_meta": "false",
                        "log_data": "true",
                        "bucket_index_max_shards": 11,
                        "read_only": "false",
                        "tier_type": "",
                        "sync_from_all": "true",
                        "sync_from": [],
                        "redirect_zone": "",
                        "supported_features": [
                            "resharding"
                        ]
                    },
                    {
                        "id": "d7c2da60-e269-4681-a231-e744d1f0dc8a",
                        "name": "archive",
                        "endpoints": [
                            "http://proxy02:8000"
                        ],
                        "log_meta": "false",
                        "log_data": "true",
                        "bucket_index_max_shards": 11,
                        "read_only": "false",
                        "tier_type": "archive",
                        "sync_from_all": "true",
                        "sync_from": [],
                        "redirect_zone": "",
                        "supported_features": [
                            "resharding"
                        ]
                    }
                ],
                "placement_targets": [
                    {
                        "name": "default-placement",
                        "tags": [],
                        "storage_classes": [
                            "STANDARD"
                        ]
                    }
                ],
                "default_placement": "default-placement",
                "realm_id": "da2a45d7-764b-4c92-a28a-049d02c8c22f",
                "sync_policy": {
                    "groups": []
                },
                "enabled_features": [
                    "resharding"
                ]
            }
        ],
        "short_zone_ids": [
            {
                "key": "1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f",
                "val": 3465814334
            },
            {
                "key": "d7c2da60-e269-4681-a231-e744d1f0dc8a",
                "val": 702125852
            }
        ]
    },
    "master_zonegroup": "fc3debfe-2a29-448b-baa8-1e54c7eee9b1",
    "master_zone": "1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f",
    "period_config": {
        "bucket_quota": {
            "enabled": false,
            "check_on_raw": false,
            "max_size": -1,
            "max_size_kb": 0,
            "max_objects": -1
        },
        "user_quota": {
            "enabled": false,
            "check_on_raw": false,
            "max_size": -1,
            "max_size_kb": 0,
            "max_objects": -1
        }
    },
    "realm_id": "da2a45d7-764b-4c92-a28a-049d02c8c22f",
    "realm_name": "multisite",
    "realm_epoch": 2
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the RADOS Gateway service for the secondary zone.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ceph orch apply rgw multi.archive --realm=multisite --zone=archive --placement="2 proxy02 ceph-mon02" --port=8000
Scheduled rgw.multi.archive update...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the radosgw-admin sync status command, we can see the sync is started and a
full copy of the master zone is being synced to the Archive zone</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin sync status
          realm e72107cb-4b3f-49b9-abb0-83c68a9967f9 (multisite)
      zonegroup 6b9fbc87-3202-4a35-85d0-e3e16fc91b32 (multizg)
           zone ec5a7187-95e1-4bf2-8519-208175c81487 (Archive)
   current time 2022-12-23T14:41:08Z
  metadata sync syncing
                full sync: 1/64 shards
                full sync: 21 entries to sync
                incremental sync: 63/64 shards
                metadata is behind on 1 shards
                behind shards: [0]
      data sync source: c5dc9503-6c11-4851-91bd-f1d5ca61473c (zone1)
                        syncing
                        full sync: 63/128 shards
                        full sync: 77 buckets to sync
                        incremental sync: 65/128 shards
                        data is behind on 63 shards
                        behind shards: [4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,36,37,38,39,40,41,42,43,44,45,46,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,105,106,107,108,109,110,111,112,113,114,115,116]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The output can differ depending on the sync status. The shards are described as two different types during sync:
- Behind shards are shards that need a full data sync and shards needing an incremental data sync because they are not up-to-date.
- Recovery shards are shards that encountered an error during sync and marked for retry. The error mostly occurs on minor issues like acquiring a lock on a bucket. This will typically resolve itself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you encounter sync errors in your configuration, with shards falling behind
, you can run the commandi <code># radosgw-admin  sync error list</code>.
Also increasing the verbosity of
the RGW logs is a good place to start looking for errors, to increase the
verbosity you can follow the steps of this
<a href="https://access.redhat.com/solutions/2085183">KCS</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After a while if we run the same command we will probably see metadata and data in sync:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin sync status
          realm da2a45d7-764b-4c92-a28a-049d02c8c22f (multisite)
      zonegroup fc3debfe-2a29-448b-baa8-1e54c7eee9b1 (multizg)
           zone d7c2da60-e269-4681-a231-e744d1f0dc8a (archive)
   current time 2023-03-15T11:27:00Z
zonegroup features enabled: resharding
  metadata sync syncing
                full sync: 0/64 shards
                incremental sync: 64/64 shards
                metadata is caught up with master
      data sync source: 1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f (zone1)
                        syncing
                        full sync: 0/128 shards
                        incremental sync: 128/128 shards
                        data is caught up with source</code></pre>
</div>
</div>
<div class="paragraph">
<p>The replication with the Archive zone is uni-directional, so only objects from
zone1 will be replicated to the archive zone, and not the other way around.</p>
</div>
<div class="paragraph">
<p>That is why if we check the same radosgw-admin sync status command on the
cluster from zone1, we can see there us no data sync information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin sync status
          realm da2a45d7-764b-4c92-a28a-049d02c8c22f (multisite)
      zonegroup fc3debfe-2a29-448b-baa8-1e54c7eee9b1 (multizg)
           zone 1ed728d7-f0bf-4401-8ea8-657c9f1f4b0f (zone1)
   current time 2023-03-15T11:31:00Z
zonegroup features enabled: resharding
  metadata sync no sync (zone is master)
      data sync source: d7c2da60-e269-4681-a231-e744d1f0dc8a (archive)
                        not syncing from zone</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prepare_the_client_environment"><a class="anchor" href="#_prepare_the_client_environment"></a>2.4. Prepare the client Environment.</h3>
<div class="paragraph">
<p>We are going to use 2 clients, the aws cli and the rclone cli tool.</p>
</div>
<div class="paragraph">
<p>First we are going to create a specific user for our tests, sone in our zone1
cluster we run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin user create --uid=archuser --display-name="S3 user to test the archive zone" --access-key=archuser
--secret-key=archuser
{
    "user_id": "archuser",
    "display_name": "S3 user to test the archive zone",
    "email": "",
    "suspended": 0,
    "max_buckets": 1000,
    "subusers": [],
    "keys": [
        {
            "user": "archuser",
            "access_key": "archuser",
            "secret_key": "archuser"
        }
    ],
    "swift_keys": [],
    "caps": [],
    "op_mask": "read, write, delete",
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    "bucket_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": 0,
        "max_objects": -1
    },
    "user_quota": {
        "enabled": false,
        "check_on_raw": false,
        "max_size": -1,
        "max_size_kb": 0,
        "max_objects": -1
    },
    "temp_url_keys": [],
    "type": "rgw",
    "mfa_ids": []
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to configure the AWS client with this user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws configure
AWS Access Key ID [None]: archuser
AWS Secret Access Key [None]: archuser
Default region name [None]: multizg
Default output format [None]: text</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m also going to create a couple of alias to make our life easier.</p>
</div>
<div class="paragraph">
<p>Alias for zone1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># alias s3apiarchive='aws --endpoint=http://proxy02:8000 s3api'
# alias s3apizone1='aws --endpoint=http://proxy01:8000 s3api'</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will also use rclone, so lets download and install the rclone rpm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># yum install https://downloads.rclone.org/v1.62.0/rclone-v1.62.0-linux-amd64.rpm -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the rclone client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># mkdir -p /root/.config/rclone/
# cat &lt;&lt;EOF &gt; /root/.config/rclone/rclone.conf
[zone1]
type = s3
provider = Other
access_key_id = archuser
secret_access_key = archuser
endpoint = http://proxy01:8000
location_constraint = multizg
acl = bucket-owner-full-control

[archive]
type = s3
provider = Ceph
access_key_id = archuser
secret_access_key = archuser
endpoint = http://proxy02:8000
location_constraint = multizg
acl = bucket-owner-full-control
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create some test files and get the output of their MD5 sum, so we can
review further down the line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># echo "This is file 1" &gt; /tmp/test-file-1
# echo "This is file 2" &gt; /tmp/test-file-2
# echo "This is file 3" &gt; /tmp/test-file-3
# md5sum /tmp/test-file-1
88c16a56754e0f17a93d269ae74dde9b  /tmp/test-file-1
# md5sum /tmp/test-file-2
db06069ef1c9f40986ffa06db4fe8fd7  /tmp/test-file-2
# md5sum /tmp/test-file-3
95227e10e2c33771e1c1379b17330c86  /tmp/test-file-3</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_archive_zone_testing"><a class="anchor" href="#_archive_zone_testing"></a>2.5. Archive Zone testing</h3>
<div class="paragraph">
<p>We have our client&#8217;s ready, let&#8217;s check out the archive zone.</p>
</div>
<div class="paragraph">
<p>Create a new bucket and verify the bucket has been created in all RGW zones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># s3apizone1 create-bucket --bucket my-bucket
# s3apizone1 list-buckets
BUCKETS 2023-03-15T12:03:54.315000+00:00        my-bucket
OWNER   S3 user to test the archive zone        archuser
# s3apiarchive list-buckets
BUCKETS 2023-03-15T12:03:54.315000+00:00        my-bucket
OWNER   S3 user to test the archive zone        archuser</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the object versioning is not yet configured as this is implemented lazily</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># s3apizone1 get-bucket-versioning --bucket my-bucket
# s3apiarchive get-bucket-versioning --bucket my-bucket</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upload a new object to our bucket my-bucket and verify the object has been created in all RGW zones</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone copy /tmp/test-file-1 zone1:my-bucket</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify how S3 versioning has been enabled in the archive zone but not in zone1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># s3apiarchive get-bucket-versioning --bucket my-bucket
{
    "Status": "Enabled",
    "MFADelete": "Disabled"
}
# s3apizone1 get-bucket-versioning --bucket my-bucket</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify object version ID is null in master and secondary zone but not in the archive zone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># s3apizone1 list-object-versions --bucket my-bucket
{
    "Versions": [
        {
            "ETag": "\"88c16a56754e0f17a93d269ae74dde9b\"",
            "Size": 15,
            "StorageClass": "STANDARD",
            "Key": "test-file-1",
            "VersionId": "null",
            "IsLatest": true,
            "LastModified": "2023-03-15T12:07:12.914000+00:00",
            "Owner": {
                "DisplayName": "S3 user to test the archive zone",
                "ID": "archuser"
            }
        }
    ]
}

# s3apiarchive list-object-versions --bucket my-bucket
{
    "Versions": [
        {
            "ETag": "\"88c16a56754e0f17a93d269ae74dde9b\"",
            "Size": 15,
            "StorageClass": "STANDARD",
            "Key": "test-file-1",
            "VersionId": "6DRlC7fKtpmkvHA9zknhFA87RjyilTV",
            "IsLatest": true,
            "LastModified": "2023-03-15T12:07:12.914000+00:00",
            "Owner": {
                "DisplayName": "S3 user to test the archive zone",
                "ID": "archuser"
            }
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify the object in the master zone and verify a new version is created in the RGW archive zone.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone copyto /tmp/test-file-2 zone1:my-bucket/test-file-1
# rclone ls zone1:my-bucket
       15 test-file-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify a new version has been created in the RGW archive zone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># s3apiarchive list-object-versions --bucket my-bucket
{
    "Versions": [
        {
            "ETag": "\"db06069ef1c9f40986ffa06db4fe8fd7\"",
            "Size": 15,
            "StorageClass": "STANDARD",
            "Key": "test-file-1",
            "VersionId": "mXoINEnZsSCDNaWwCDELVysUbnMqNqx",
            "IsLatest": true,
            "LastModified": "2023-03-15T12:13:27.057000+00:00",
            "Owner": {
                "DisplayName": "S3 user to test the archive zone",
                "ID": "archuser"
            }
        },
        {
            "ETag": "\"88c16a56754e0f17a93d269ae74dde9b\"",
            "Size": 15,
            "StorageClass": "STANDARD",
            "Key": "test-file-1",
            "VersionId": "6DRlC7fKtpmkvHA9zknhFA87RjyilTV",
            "IsLatest": false,
            "LastModified": "2023-03-15T12:07:12.914000+00:00",
            "Owner": {
                "DisplayName": "S3 user to test the archive zone",
                "ID": "archuser"
            }
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the ETag it will match the MD5sum for the file, this is only the
case if multipart upload or object encryption is configured.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># md5sum /tmp/test-file-2
db06069ef1c9f40986ffa06db4fe8fd7  /tmp/test-file-2
# md5sum /tmp/test-file-1
88c16a56754e0f17a93d269ae74dde9b  /tmp/test-file-1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_recovering_s3_objects_from_the_rgw_archive_zone"><a class="anchor" href="#_recovering_s3_objects_from_the_rgw_archive_zone"></a>2.6. Recovering S3 objects from the RGW archive zone</h3>
<div class="paragraph">
<p>Let&#8217;s update one more version of the object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone copyto /tmp/test-file-3 zone1:my-bucket/test-file-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the primary zone we only have one version, the current version of the object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone --s3-versions lsl zone1:my-bucket
       15 2023-03-15 07:59:10.779573336 test-file-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>But in the Archive zone we have all 3 versions available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone --s3-versions lsl archive:my-bucket
       15 2023-03-15 07:59:10.779573336 test-file-1
       15 2023-03-15 07:59:03.782438991 test-file-1-v2023-03-15-121327-057
       15 2023-03-15 07:58:58.135330567 test-file-1-v2023-03-15-120712-914</code></pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s delete test-file1 from my-bucket in zone1, and recover the object from
the archive zone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone delete zone1:my-bucket/test-file-1
# rclone --s3-versions lsl zone1:my-bucket
# rclone --s3-versions lsl archive:my-bucket
       15 2023-03-15 07:59:10.779573336 test-file-1
       15 2023-03-15 07:59:03.782438991 test-file-1-v2023-03-15-121327-057
       15 2023-03-15 07:58:58.135330567 test-file-1-v2023-03-15-120712-914</code></pre>
</div>
</div>
<div class="paragraph">
<p>The object has been delete from zone1, but still available in the archive zone
with all it&#8217;s versions, if we recover the latest version test-file-1 it should
match with the md5 for out test-file-3.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone copyto archive:my-bucket/test-file-1 zone1:my-bucket/test-file-1
# rclone copyto zone1:my-bucket/test-file-1 /tmp/recovered-file1
# md5sum /tmp/recovered-file1
95227e10e2c33771e1c1379b17330c86  /tmp/recovered-file1
# md5sum /tmp/test-file-3
95227e10e2c33771e1c1379b17330c86  /tmp/test-file-3</code></pre>
</div>
</div>
<div class="paragraph">
<p>But let&#8217;s say that we want to recover the object with the version that has date 2023-03-15-121327-057.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rclone --s3-versions copyto archive:my-bucket/test-file-1-v2023-03-15-121327-057 zone1:my-bucket/test-file-1
# rclone copyto zone1:my-bucket/test-file-1 /tmp/recovered-file1
# md5sum /tmp/recovered-file1
db06069ef1c9f40986ffa06db4fe8fd7  /tmp/recovered-file1
# md5sum /tmp/test-file-2
db06069ef1c9f40986ffa06db4fe8fd7  /tmp/test-file-2</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Ceph">
  </a>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
