<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ceph RadosGW Challenge :: Ceph Top Gun Enablement</title>
    <link rel="canonical" href="https://likid0.github.io/ceph-top-gun-enablement/training/ceph/ceph_rgw_challenge_solution.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="48px" alt="Ceph">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/zh-cn/red_hat_ceph_storage/5" target="_blank">Ceph Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/likid0/ceph-top-gun-enablement/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">Ceph Storage Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Ceph Top-Gun Enablement</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Lab Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opentlc_lab_env.html">Opentlc Lab Env</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Ceph</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_introduction.html">Ceph Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_architecture.html">Ceph Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cluster_partitioning.html">Ceph Cluster Partitioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_hardware.html">Ceph Hardware Recommendations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_intro.html">Ceph Install Methods </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephadm_intro.html">Cephadm Orchestrator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_basic.html">Deploy Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_ui.html">Deploy Ceph from the UI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_dashboard_metrics.html">Ceph Dashboard Management &amp; Metrics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cli_intro.html">Ceph CLI basic commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_configuration.html">Ceph Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_pools.html">Ceph storage pools config</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_pgs.html">Ceph Health and PGs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_bluestore.html">Ceph OSD Bluestore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_recovery.html">Ceph OSD Failure/Recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephx.html">Rados CephX Auth/AuthZ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_version.html">What version of Ceph am I running?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph-upgrades_cephadm.html">Upgrade Ceph with Cephadm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_challenge.html">Challenge Ceph Deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RADOS Block Device</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_intro.html">RADOS Block Device introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_export.html">RBD Import/Export</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_mirroring.html">RBD Mirroring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_challenge.html">Challenge RBD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CephFS Shared FileSystem</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_intro.html">CephFS introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_advanced.html">CephFS Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephfs_challenge.html">Challenge Cephfs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RadosGW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_intro.html">RGW Introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_arch_deep_dive.html">RGW Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ha.html">RGW High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ssl.html">RGW &amp; Ingress with SSL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_users_quotas.html">RGW Users &amp; Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_auth.html">RGW Auth &amp; Authz</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_object_versioning.html">RGW S3 Object Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_placement_and_storage_classes.html">RGW Placement &amp; Storage Classes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_life_cycle_management.html">RGW Life Cycle Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_policy.html">RGW S3 Bucket Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_introduction.html">RGW Secure Token Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_bucket_role_policy.html">RGW Bucket vs Role Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_cloudsync.html">RGW Object Cloud Transition</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_archive.html">RGW Archive Zone</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_presignedurl.html">RGW presigned URL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_opslog.html">RGW Opslog</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_notification.html">RGW bucket Notification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_rgw_challenge.html">Challenge RGW</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_logging.html">Troubleshooting Logs Debug Mode</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-nearfull-osds.html">Troubleshooting nearfull OSDs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_bluestore.html">Troubleshooting Bluestore issues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-large-omap-objects.html">Troubleshooting Large Omap Objects</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting_break_and_fix.html">Troubleshooting Break &amp; Fix Hands-on</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Benchmarking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_example.html">Setting the Inital Baseline</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_fio.html">Benchmarking Ceph block and File</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_performance_object.html">Benchmarking Ceph Object(RGW)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Stretched</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rhcs-stretched-deploy.html">Ceph Stretch Mode</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Challenge Solutions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_challenge_solution.html">Ceph Deployment Solution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephrbd_challenge_solution.html">Ceph RBD Solution</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephfs_challenge_solution.html">Ceph CephFS Solution</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="ceph_rgw_challenge_solution.html">Ceph RGW Solution</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ceph Top-Gun Enablement</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Ceph Top-Gun Enablement</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Ceph Top-Gun Enablement</a></li>
    <li>Ceph Challenge Solutions</li>
    <li><a href="ceph_rgw_challenge_solution.html">Ceph RGW Solution</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/training/modules/ceph/pages/ceph_rgw_challenge_solution.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Ceph RadosGW Challenge</h1>
<div class="sect1">
<h2 id="_goals"><a class="anchor" href="#_goals"></a>1. Goals</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Deploy RGW in HA mode</p>
</li>
<li>
<p>Work with Placement Targets and Storage Classes</p>
</li>
<li>
<p>Use Life Cycle policies to transition object to other tiers</p>
</li>
<li>
<p>Work with bucket policies</p>
</li>
<li>
<p>Configure basic STS authentication</p>
</li>
<li>
<p>Secure the RGW endpoint with SSL</p>
</li>
<li>
<p>Audit all S3 operations in RGW</p>
</li>
<li>
<p>Configure a Multisite Replicated</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_rgw_services"><a class="anchor" href="#_deploy_rgw_services"></a>2. Deploy RGW services</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_exercide"><a class="anchor" href="#_exercide"></a>2.1. Exercide</h3>
<div class="ulist">
<ul>
<li>
<p>Create a realm called <code>single</code>, add a zonegroup called <code>singlezg</code>, and a master zone called <code>singlezone</code></p>
</li>
<li>
<p>Deploy two RGW services, using the above-mentioned realm and zone, on port 8080</p>
</li>
<li>
<p>Create a test user called <code>user1</code>, and test rgw setup by creating a bucket * called <code>bucket1</code> and upload an object with S3 client</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution"><a class="anchor" href="#_solution"></a>2.2. Solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin realm create --rgw-realm=single --default
# radosgw-admin zonegroup create --rgw-zonegroup=singlezg --master --default
# radosgw-admin zone create --rgw-zonegroup=singlezg --rgw-zone=singlezone --master --default
# radosgw-admin period update --rgw-realm=single --commit
# ceph orch apply rgw single.zone --realm=single --zone=singlezone --placement="2 proxy01 ceph-node02" --port=8080
# radosgw-admin user create --uid='user1' --display-name='First User' --access-key='user1' --secret-key='user1'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws configure
AWS Access Key ID [None]: user1
AWS Secret Access Key [None]: user1
Default region name [None]: singlezg
Default output format [None]: text
# aws s3 --endpoint http://proxy01:8080 mb s3://bucket1 --region singlezg</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_a_securedssl_ingress_service_to_provide_ha"><a class="anchor" href="#_deploy_a_securedssl_ingress_service_to_provide_ha"></a>3. Deploy a secured(SSL) Ingress service to provide HA</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_exercise"><a class="anchor" href="#_exercise"></a>3.1. Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Deploy an ingress service using ip <code>192.168.56.100</code> that will load-balance client requests between both of the deployed RGW services</p>
</li>
<li>
<p>Configure SSL, the SSL termination must be done at the Ingress/HAproxy level</p>
<div class="ulist">
<ul>
<li>
<p>You can use certificates available on /root/certificates of the admin nodes,
or create your own custom certificates, the SAN of the provided certs covers <code>s3.example.com</code> and <code>s3zone1.example.com</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_2"><a class="anchor" href="#_solution_2"></a>3.2. Solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># cat &lt;&lt; EOF &gt;  rgw-ingress.yaml
service_type: ingress
service_id: rgw.objectgw
placement:
  hosts:
    - ceph-node02
    - ceph-node03
spec:
  backend_service: rgw.single.zone
  virtual_ip: 192.168.56.100/24
  frontend_port: 443
  monitor_port:  1967
  ssl_cert: |
     -----BEGIN CERTIFICATE-----
$( cat /root/certificates/certificate.pem | grep -v CERTIFICATE | awk '{$1="     "$1}1' )
     -----END CERTIFICATE-----
     -----BEGIN RSA PRIVATE KEY-----
$( cat /root/certificates/certificate.key | grep -v PRIVATE | awk '{$1="     "$1}1' )
     -----END RSA PRIVATE KEY-----
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ceph orch apply -i rgw-ingress.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a couple of minutes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># curl https://s3zone1.example.com &lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;ListAllMyBucketsResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;&lt;Owner&gt;&lt;ID&gt;anonymous&lt;/ID&gt;&lt;DisplayName&gt;&lt;/DisplayName&gt;&lt;/Owner&gt;&lt;Buckets&gt;&lt;/Buckets&gt;&lt;/ListAllMyBucketsResult&gt;
# aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 ls</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_a_new_placement_target_to_zonegroup_singlezg"><a class="anchor" href="#_add_a_new_placement_target_to_zonegroup_singlezg"></a>4. Add a new placement target to zonegroup <code>singlezg</code></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_exercise_2"><a class="anchor" href="#_exercise_2"></a>4.1. Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Create dedicated EC pools for the placement target</p>
<div class="ulist">
<ul>
<li>
<p>Create a new EC pool called <code>singlezone.rgw.ssd.buckets.data</code> pg count 32, with 2+1 EC and host failure domain
WARNING: EC 2+1 Setting is not supported in production, just for lab testing, check-out valid configurations <a href="https://access.redhat.com/articles/1548993">here</a></p>
<div class="ulist">
<ul>
<li>
<p>Enable Bluestore compression: aggressive, snappy</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a new replicated pool <code>singlezone.rgw.ssd.buckets.index</code> pg count: 8, replica 3 and host failure domain</p>
</li>
<li>
<p>Create a new replicated pool <code>singlezone.rgw.ssd.buckets.non-ec</code> pg count: 8, replica 3 and host failure domain</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a Placement target called <code>rgwec</code></p>
<div class="ulist">
<ul>
<li>
<p>Users should be able to store data on the new placement target using a reference tag when they create their buckets</p>
</li>
<li>
<p>Modify <code>user1</code> adding the new tag, create a bucket with reference tag <code>rgwec</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_3"><a class="anchor" href="#_solution_3"></a>4.2. Solution</h3>
<div class="paragraph">
<p>Create the requested pools for the Placement Target and also enable compresion
for the data pool <code>singlezone.rgw.ssd.buckets.data</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ceph osd pool create zone1.rgw.ssd.buckets.index 8 8 replicated
# ceph osd pool create zone1.rgw.ssd.buckets.non-ec 8 8 replicated
# ceph osd erasure-code-profile set profile21 k=2 m=1
# ceph osd pool create singlezone.rgw.ssd.buckets.data 32 32 erasure profile21
# ceph osd pool application enable zone1.rgw.ssd.buckets.index rgw
# ceph osd pool application enable zone1.rgw.ssd.buckets.non-ec rgw
# ceph osd pool application enable singlezone.rgw.ssd.buckets.data rgw
# ceph osd pool set singlezone.rgw.ssd.buckets.data compression_mode aggressive
# ceph osd pool set singlezone.rgw.ssd.buckets.data compression_algorithm snappy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the placement group called <code>rgwec</code> , and add the dedicated pools for
this new placement group</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zonegroup placement add --rgw-zonegroup singlezg --placement-id rgwec
# radosgw-admin zone placement add --rgw-zone singlezone --placement-id rgwec --data-pool singlezone.rgw.ssd.buckets.data --index-pool singlezone.rgw.ssd.buckets.index --data-extra-pool singlezone.rgw.ssd.buckets.non-ec
#  radosgw-admin period update --commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to add a tag called <code>allowed-rgwrc</code> so only users with this tag are able to create buckets in this placement group</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zonegroup get &gt; /etc/ceph/zonegroup.json
# vi /etc/ceph/zonegroup.json
{
    "id": "41eed131-da38-461e-a5ca-b633189f7f38",
    "name": "singlezg",
    "api_name": "singlezg",
    "is_master": "true",
    "endpoints": [],
    "hostnames": [],
    "hostnames_s3website": [],
    "master_zone": "d2aca484-dfa7-433d-8469-8df6a3a242e9",
    "zones": [
        {
            "id": "d2aca484-dfa7-433d-8469-8df6a3a242e9",
            "name": "singlezone",
            "endpoints": [],
            "log_meta": "false",
            "log_data": "false",
            "bucket_index_max_shards": 11,
            "read_only": "false",
            "tier_type": "",
            "sync_from_all": "true",
            "sync_from": [],
            "redirect_zone": "",
            "supported_features": [
                "resharding"
            ]
        }
    ],
    "placement_targets": [
        {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "STANDARD"
            ]
        },
        {
            "name": "rgwec",
            "tags": ["allowed-rgwrc"],       &lt;---- Add Tag to placement targer
            "storage_classes": [
                "STANDARD"
            ]
        }
    ],
    "default_placement": "default-placement",
    "realm_id": "5bc04cc6-1ddb-47e3-ab8b-5d556c63ae9b",
    "sync_policy": {
        "groups": []
    },
    "enabled_features": [
        "resharding"
    ]
}

# radosgw-admin zonegroup set &lt; /etc/ceph/zonegroup.json
# radosgw-admin period update --commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we add the tag <code>allowed-rgwrc</code> so we allow user1 to use the new placement group we created with the EC data pool</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin user modify --uid user1 --placement-id default-placement --storage-class STANDARD --tags allowed-rgwrc</code></pre>
</div>
</div>
<div class="paragraph">
<p>As user1 if we create a bucket with specifiying the placement group it will get
create in the default placement called <code>default-placement</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api create-bucket --bucket normalbucket --region singlezg
# radosgw-admin bucket stats --bucket normalbucket | grep placement_rule
    "placement_rule": "default-placement",</code></pre>
</div>
</div>
<div class="paragraph">
<p>As user1 if we use the LocationConstraint with <code>singlezg:rgwec</code> we will create
the bucket in the rgwec placement group</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api create-bucket --bucket my-bucket --region singlezg --create-bucket-configuration LocationConstraint=singlezg:rgwec

# radosgw-admin bucket stats --bucket my-bucket | grep placement_rule
    "placement_rule": "rgwec",

# radosgw-admin bucket stats --bucket my-bucket | grep marker
    "marker": "d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1",
    "max_marker": "0#,1#,2#,3#,4#,5#,6#,7#,8#,9#,10#",

# rados -p singlezone.rgw.ssd.buckets.index ls | grep 44443
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.8
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.2
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.9
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.5
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.3
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.7
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.6
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.0
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.10
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.1
.dir.d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.1.4</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_a_lifecycle_policy_to_transition_objects_to_a_cold_storage_class"><a class="anchor" href="#_configure_a_lifecycle_policy_to_transition_objects_to_a_cold_storage_class"></a>5. Configure a LifeCycle policy to transition objects to a COLD Storage Class</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_exercise_3"><a class="anchor" href="#_exercise_3"></a>5.1. Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Create a new RGW data pool used for storing Cold Data</p>
<div class="ulist">
<ul>
<li>
<p>Create a new EC pool called <code>singlezone.rgw.cold.buckets.data</code> pg count 16, with 2+1 EC and host failure domain</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a new Storage Class called <code>COLD</code> in the DEFAULT Placement Group</p>
<div class="ulist">
<ul>
<li>
<p>Create a new bucket called <code>data1</code></p>
</li>
<li>
<p>Configure a Life Cycle policy that will transition objects to the <code>COLD</code> Storage class after 10 days</p>
</li>
<li>
<p>Apply the LCP to the <code>data1</code> bucket</p>
</li>
<li>
<p>Upload some objects and test the LCP is working(Remember rgw_lc_debug_interval to speed things up)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_4"><a class="anchor" href="#_solution_4"></a>5.2. Solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ceph osd pool create singlezone.rgw.cold.buckets.data 16 16  erasure profile21
# ceph osd pool application enable singlezone.rgw.cold.buckets.data  rgw</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin zonegroup placement add --rgw-zonegroup singlezg --placement-id default-placement --storage-class COLD
# radosgw-admin zone placement add --rgw-zone singlezone --placement-id default-placement --storage-class COLD --data-pool singlezone.rgw.cold.buckets.data
# radosgw-admin period update --commit</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api create-bucket --bucket data1 --region singlezg
# aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 cp /etc/hosts s3://data1/hosts --region singlezg
# aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api list-objects-v2 --bucket data1 | jq '.Contents[].StorageClass'
"STANDARD"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># cat lc_cold.xml
{
    "Rules": [
     {
      "ID": "Archive all objects older than 10 days",
      "Filter": {
        "Prefix": ""
      },
      "Status": "Enabled",
      "Transitions": [
        {
        "Days": 10,
        "StorageClass": "COLD"
        }
     ]
    }
  ]
}


# aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api put-bucket-lifecycle-configuration --bucket data1 --lifecycle-configuration file://lc_cold.xml

# aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api get-bucket-lifecycle-configuration --bucket data1
{
    "Rules": [
        {
            "ID": "Archive all objects older than 10 days",
            "Prefix": "",
            "Status": "Enabled",
            "Transitions": [
                {
                    "Days": 10,
                    "StorageClass": "COLD"
                }
            ]
        }
    ]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># rados ls -p singlezone.rgw.buckets.data
d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.2_hosts2
d2aca484-dfa7-433d-8469-8df6a3a242e9.44443.2_hosts</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>just for the transition to happen faster we are going to set the following
value:</p>
</div>
<div class="paragraph">
<p># ceph config set client.rgw rgw_lc_debug_interval 10</p>
</div>
<div class="paragraph">
<p>And restart the RGWs.</p>
</div>
<div class="paragraph">
<p># ceph orch restart rgw.single.zone</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api list-objects-v2 --bucket data1 | jq '.Contents[].StorageClass'
"COLD"
"COLD"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_bucket_policy"><a class="anchor" href="#_create_a_bucket_policy"></a>6. Create a Bucket policy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_exercise_4"><a class="anchor" href="#_exercise_4"></a>6.1. Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Create a new user called <code>user2</code>, and create a bucket called <code>policy</code> with the following layout:</p>
<div class="ulist">
<ul>
<li>
<p>Policy</p>
<div class="ulist">
<ul>
<li>
<p>Policy/reads</p>
</li>
<li>
<p>Policy/write</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create a Bucket policy that will give <code>user1</code> the following access to bucket <code>policy</code></p>
<div class="ulist">
<ul>
<li>
<p>Policy/ &#8592;  list objects(not read/GET)</p>
</li>
<li>
<p>Policy/reads &#8592; read(GET)</p>
</li>
<li>
<p>Policy/write &#8592;  write(PUT/DELETE)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_5"><a class="anchor" href="#_solution_5"></a>6.2. Solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># radosgw-admin user create --uid='user2' --display-name='First User' --access-key='user2' --secret-key='user2'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># cat .aws/credentials
[user1]
aws_access_key_id = user1
aws_secret_access_key = user1
[user2]
aws_access_key_id = user2
aws_secret_access_key = user2

# aws --profile user2 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 mb s3://policy --region singlezg
# aws --profile user2 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 cp /etc/hosts s3://policy/read/read --region singlezg
# aws --profile user2 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 cp /etc/hosts s3://policy/write/write --region singlezg</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --profile user1 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 ls s3://policy
An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Unknown</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># cat ok.yaml
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam:::user/user1"
        ]
      },
      "Action": [
        "s3:ListBucket",
        "s3:ListBucketMultipartUploads",
        "s3:Get*"
      ],
      "Resource": [
        "arn:aws:s3:::policy"
      ]
    },
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam:::user/user1"
        ]
      },
      "Action": [
      "s3:Get*",
      "s3:ListMultipartUploadParts"
      ],
      "Resource": [
        "arn:aws:s3:::policy/read/*",
        "arn:aws:s3:::policy/read",
        "arn:aws:s3:::policy/read/"
      ]
    },
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": [
          "arn:aws:iam:::user/user1"
        ]
      },
      "Action": [
      "s3:Get*",
      "s3:PutObject",
      "s3:DeleteObject",
      "s3:AbortMultipartUpload",
      "s3:ListMultipartUploadParts"
      ],
      "Resource": [
        "arn:aws:s3:::policy/write-folder/*",
        "arn:aws:s3:::policy/write-folder",
        "arn:aws:s3:::policy/write-folder/"
      ]
    }
  ]
}

# aws --profile user2 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3api put-bucket-policy --bucket policy --policy file://ok.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># aws --profile user1 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 ls s3://policy
                           PRE read/
                           PRE write/
# aws --profile user1 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 ls s3://policy/read/
2023-03-02 07:30:49       1330 read
# aws --profile user1 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 rm s3://policy/read/read
delete failed: s3://policy/read/read An error occurred (AccessDenied) when calling the DeleteObject operation: Unknown
# aws --profile user1 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 cp /etc/hosts s3://policy/read/noperms
upload failed: ../etc/hosts to s3://policy/read/noperms An error occurred (AccessDenied) when calling the PutObject operation: Unknown
# aws --profile user1 --ca-bundle /etc/ssl/certs/ca-bundle.crt --endpoint https://s3zone1.example.com s3 cp /etc/hosts s3://policy/write/ok
upload: ../etc/hosts to s3://policy/write/ok</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_local_database_stsusing_assumerole"><a class="anchor" href="#_configure_local_database_stsusing_assumerole"></a>7. Configure Local Database STS(using AssumeRole)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_exercise_5"><a class="anchor" href="#_exercise_5"></a>7.1. Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>We need to allow <code>user1</code> and <code>user2</code> to assume an IAM role called <code>role1</code> that will give them full access to a bucket called <code>admin</code></p>
<div class="ulist">
<ul>
<li>
<p>Create a new RGW <code>admin</code> user</p>
<div class="ulist">
<ul>
<li>
<p>With the <code>admin</code> user create an <code>admin</code> bucket and add 1 object</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enable the STS endpoint in the RGW services</p>
</li>
<li>
<p>Create a new IAM role called <code>admin</code></p>
</li>
<li>
<p>Create a Role Policy Document that will allow <code>user1</code> and <code>user2</code> to assume <code>role1</code></p>
</li>
<li>
<p>Create a new role policy that allows <code>user1</code> and <code>user2</code> full access to bucket <code>admin</code></p>
</li>
<li>
<p>Using an AWS client assume the IAM <code>admin</code> role using STS</p>
</li>
<li>
<p>Use the temporal token created to access the <code>admin</code> bucket</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_6"><a class="anchor" href="#_solution_6"></a>7.2. Solution</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_audit_all_s3_operations"><a class="anchor" href="#_audit_all_s3_operations"></a>8. Audit all S3 operations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Configure the opslog, so all S3 operations get stored in * /var/log/ceph/<code>FSID</code>/opslog.log</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_a_new_realm_that_has_multisite_replication"><a class="anchor" href="#_configure_a_new_realm_that_has_multisite_replication"></a>9. Configure a new realm that has multisite replication</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>New Realm/Zonegroup/Zone</p>
<div class="ulist">
<ul>
<li>
<p>On site1 the one we already have configured, we need to create:</p>
<div class="ulist">
<ul>
<li>
<p>A realm called: <code>multi</code></p>
</li>
<li>
<p>A zonegroup called: <code>singlezg1</code></p>
</li>
<li>
<p>A zone called: <code>singlezone1</code></p>
</li>
<li>
<p>New RGW instances and pools for this Realm</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>We need a second Ceph Cluster configured</p>
<div class="ulist">
<ul>
<li>
<p>The second site ceph deployment needs:</p>
<div class="ulist">
<ul>
<li>
<p>A realm called: <code>multi</code></p>
</li>
<li>
<p>A zonegroup called: <code>singlezg2</code></p>
</li>
<li>
<p>A zone called: <code>singlezone2</code></p>
</li>
<li>
<p>RGW instances and pools for this Realm</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Test that the Multisite replication is working between sites.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enable_per_bucket_replication"><a class="anchor" href="#_enable_per_bucket_replication"></a>10. Enable per-bucket replication</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Disable Full zonegroup replication</p>
</li>
<li>
<p>Create a new bucket called <code>sync1</code></p>
</li>
<li>
<p>Configure symmetrical replication for bucket <code>sync1</code></p>
</li>
<li>
<p>Create a new bucket called <code>sync2</code></p>
</li>
<li>
<p>Configure uni-directional replication from zone <code>singlezone1</code> to <code>singlezone2</code></p>
</li>
<li>
<p>Test bucket granular replication</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Ceph">
  </a>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
